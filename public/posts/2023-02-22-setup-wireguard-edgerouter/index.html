<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Setup WireGuard VPN Server on Edgerouter X (EdgeOS) | NS</title><meta name=keywords content><meta name=description content="Note: Before making any major changes, always make a backup. Refer to the official documentation on how to perform one.
Breakdown Step 1. Installation Note: The following installation guide was verified working on EdgeOS v2.0.9-hotfix.4 as of Feb 2023.
Verify your EdgeOS version show version Download Wireguard Head over to WireGuard&rsquo;s EdgeOS releases and look for the release that matches your platform/version.
On the ER-X, use curl to download the ."><meta name=author content="Angel"><link rel=canonical href=https://canonical.url/to/page><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://netsparse.dev/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://netsparse.dev/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://netsparse.dev/favicon.ico><link rel=mask-icon href=https://netsparse.dev/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Setup WireGuard VPN Server on Edgerouter X (EdgeOS)"><meta property="og:description" content="Note: Before making any major changes, always make a backup. Refer to the official documentation on how to perform one.
Breakdown Step 1. Installation Note: The following installation guide was verified working on EdgeOS v2.0.9-hotfix.4 as of Feb 2023.
Verify your EdgeOS version show version Download Wireguard Head over to WireGuard&rsquo;s EdgeOS releases and look for the release that matches your platform/version.
On the ER-X, use curl to download the ."><meta property="og:type" content="article"><meta property="og:url" content="https://netsparse.dev/posts/2023-02-22-setup-wireguard-edgerouter/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-02-22T00:00:00+00:00"><meta property="article:modified_time" content="2023-02-22T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Setup WireGuard VPN Server on Edgerouter X (EdgeOS)"><meta name=twitter:description content="Note: Before making any major changes, always make a backup. Refer to the official documentation on how to perform one.
Breakdown Step 1. Installation Note: The following installation guide was verified working on EdgeOS v2.0.9-hotfix.4 as of Feb 2023.
Verify your EdgeOS version show version Download Wireguard Head over to WireGuard&rsquo;s EdgeOS releases and look for the release that matches your platform/version.
On the ER-X, use curl to download the ."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://netsparse.dev/posts/"},{"@type":"ListItem","position":3,"name":"Setup WireGuard VPN Server on Edgerouter X (EdgeOS)","item":"https://netsparse.dev/posts/2023-02-22-setup-wireguard-edgerouter/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Setup WireGuard VPN Server on Edgerouter X (EdgeOS)","name":"Setup WireGuard VPN Server on Edgerouter X (EdgeOS)","description":"Note: Before making any major changes, always make a backup. Refer to the official documentation on how to perform one.\nBreakdown Step 1. Installation Note: The following installation guide was verified working on EdgeOS v2.0.9-hotfix.4 as of Feb 2023.\nVerify your EdgeOS version show version Download Wireguard Head over to WireGuard\u0026rsquo;s EdgeOS releases and look for the release that matches your platform/version.\nOn the ER-X, use curl to download the .","keywords":[],"articleBody":"Note: Before making any major changes, always make a backup. Refer to the official documentation on how to perform one.\nBreakdown Step 1. Installation Note: The following installation guide was verified working on EdgeOS v2.0.9-hotfix.4 as of Feb 2023.\nVerify your EdgeOS version show version Download Wireguard Head over to WireGuard’s EdgeOS releases and look for the release that matches your platform/version.\nOn the ER-X, use curl to download the .deb file\ncurl -OL https://github.com/WireGuard/wireguard-vyatta-ubnt/releases/download/1.0.20220627-1/e50-v2-v1.0.20220627-v1.0.20210914.deb Install with dpkg sudo dpkg -i e50-v2-v1.0.20220627-v1.0.20210914.deb Output Log\nuser@ER-X:~$ sudo dpkg -i e50-v2-v1.0.20220627-v1.0.20210914.deb Selecting previously unselected package wireguard. (Reading database ... 37091 files and directories currently installed.) Preparing to unpack e50-v2-v1.0.20220627-v1.0.20210914.deb ... Adding 'diversion of /opt/vyatta/share/perl5/Vyatta/Interface.pm to /opt/vyatta/share/perl5/Vyatta/Interface.pm.vyatta by wireguard' Adding 'diversion of /opt/vyatta/share/vyatta-cfg/templates/firewall/options/mss-clamp/interface-type/node.def to /opt/vyatta/share/vyatta-cfg/templates/firewall/options/mss-clamp/interface-type/node.def.vyatta by wireguard' Adding 'diversion of /opt/vyatta/share/vyatta-cfg/templates/firewall/options/mss-clamp6/interface-type/node.def to /opt/vyatta/share/vyatta-cfg/templates/firewall/options/mss-clamp6/interface-type/node.def.vyatta by wireguard' Unpacking wireguard (1.0.20220627-1) ... Setting up wireguard (1.0.20220627-1) ... If there is no space available If additional storage space is needed, you can safely delete the backup system image (not the currently running firmware).\ndelete system image You can check if wireguard is installed by running:\nwg version Output log:\nuser@ER-X:~$ wg version wireguard-tools v1.0.20210914 - https://git.zx2c4.com/wireguard-tools/ Step 2. Key Creation Confirm working directory\npwd Generate Server Keys Create folder for your server keys You can create it in the /config directory to preserve your files during upgrades, and to make it easier during backups.\ncd /config Create a folder wireguard, then create another folder for server_keys\nmkdir wireguard; cd wireguard mkdir server_keys; cd server_keys Generate a key pair for the Wireguard server\nwg genkey | tee privatekey | wg pubkey \u003e publickey Note your public and private key for the next configuration steps.\ncat publickey privatekey Generate Client Keys Move to wireguard directory.\ncd /config/wireguard Create folder wg_clients\nmkdir wg_clients ; cd wg_clients Create folder for client01\nmkdir client01 ; cd client01 Generate client keys.\nwg genkey | tee privatekey | wg pubkey \u003e publickey Note your public and private key for the next configuration steps.\ncat publickey privatekey Example output:\nuser@ER-X:~$ cat privatekey publickey sAoqK3dXpc2UbOn2LWb/MMcHTKtU0nqHjDQiXqNcyHs= Bf6LBfuoRDRbO4EJ+tawJXu6qu5BOWaXGK0V+uVRC3Q= Step 3. wg0 Interface Configuration Enter configure mode\nconfigure Set the location of the server’s private-key, previously generated\nset interfaces wireguard wg0 private-key Create the Gateway IP for the VPN and the subnet This subnet can be any private IP range, though make sure to check for conflicts\nset interfaces wireguard wg0 address 10.0.0.1/32 Create entries in the route table for the VPN subnet\nset interfaces wireguard wg0 route-allowed-ips true Set the UDP port for WG (that peers will use) WireGuard default port is 51820, but can be changed to any port\nset interfaces wireguard wg0 listen-port 51820 Save\ncommit ; save Step 4. Adding peers to the wg0 Interface Adding Client 01 Note: make sure you are in configure mode.\nset interfaces wireguard wg0 peer set interfaces wireguard wg0 peer allowed-ips 10.0.0.5/32 set interfaces wireguard wg0 peer description client01 Adding Additional Clients When adding additional peers, repeat the steps above, make sure to update allowed-ips and description for the new clients.\nset interfaces wireguard wg0 peer set interfaces wireguard wg0 peer allowed-ips 10.0.0.6/32 set interfaces wireguard wg0 peer description client02 Save\ncommit ; save Step 5. Create firewall rules for WireGuard Create an accept rule in WAN_LOCAL to accept all incoming UDP connections from port 51820 (or any port of your choice).\nset firewall name WAN_LOCAL rule 50 action accept set firewall name WAN_LOCAL rule 50 protocol udp set firewall name WAN_LOCAL rule 50 destination port 51820 set firewall name WAN_LOCAL rule 50 description 'WireGuard' Save\ncommit ; save Once this is done, your wg0 interface and firewall configuration should look something like this.\nuser@ER-X$ show configuration wireguard wg0 { address 10.0.0.1/32 listen-port 51820 peer Bf6LBfuoRDRbO4EJ+tawJXu6qu5BOWaXGK0V+uVRC3Q= { allowed-ips 10.0.0.6/32 description client02 } peer Kf6LBfuoRDRbO4EJ+tawJXu6qu5BOWaXGK0V+uVRC3Q= { allowed-ips 10.0.0.5/32 description client01 } } private-key **************** route-allowed-ips true } } rule 50 { action accept description WireGuard destination { port 51820 } log enable protocol udp source { } } } } Step 6. Constructing the Config on the peer side Config File (.conf) Create a file on the peer, with the file extension as .conf\nThe peer side needs a few pieces of information to create the tunnel:\nThe server’s public key The server’s endpoint (public IP address, or DNS record) The peer’s private key The peer’s IP address in the VPN subnet (the allowed IPs value set on the server) Therefore, the previously generated client01 private-key and the server-public-key, should be copied to the peer device.\nThe configuration should look something like the one below:\nExample Client 01 [Interface] PrivateKey = ListenPort = 51820 Address = 10.0.0.5/32 DNS = , 9.9.9.9 [Peer] PublicKey = AllowedIPs = 0.0.0.0/0 Endpoint = :51820 Example Client 02 [Interface] PrivateKey = ListenPort = 51820 Address = 10.0.0.6/32 DNS = , 9.9.9.9 [Peer] PublicKey = AllowedIPs = 0.0.0.0/0 Endpoint = :51820 Once the .conf file is created, you can import that into the peer/device of your choice.\nTo bring up your tunnel, you can use the wg-quick command.\nwg-quick up client01.conf Run wg show on your peer to verify you are connected to the endpoint.\nuser@PC$ wg show interface: client01 public key: private key: (hidden) listening port: 51820 fwmark: 0xca6c peer: endpoint: xx.xx.xx.xx:51820 allowed ips: 0.0.0.0/0 latest handshake: 11 seconds ago transfer: 3.11 MiB received, 6.92 MiB sent Step 7. Save WireGuard Keys and Configuration Files Once the above configuration is made, you can easily save the config by running a backup from the Edgerouter’s GUI.\nNavigate to the System tab in the bottom-left of the GUI to download the backup configuration archive. System \u003e Configuration Management \u0026 Device Maintenance \u003e Back Up Config\nDownload the backup config file by clicking on the Download button.\nThe EdgeRouter will prompt you to save the archive on your computer.\nYou can then extract this file on your local machine, and in the /config directory, you’ll find the wireguard public and private keys you generated earlier.\nQuick Script Warning, the following script is not guaranteed to work, you may need to modify it according to your specific platform/version. Use at your own risk.\nDetermine shell with echo $SHELL\nuser@ER-X:~$ echo $SHELL /bin/vbash EdgeOS comes with vi, you can use that to create the script.\nuser@ER-X:~$ touch wg-setup.sh user@ER-X:~$ vi wg-setup.sh NOTE: Make sure to modify your $SHELL in case it differs, for EdgeOS, it will usually be #!/bin/vbash\nPaste the following:\n#!/bin/vbash /bin/ip link add dev wg0 type wireguard /bin/ip addr add 10.0.0.1/32 dev wg0 /usr/bin/sudo /usr/bin/wg setconf wg0 /home/$USER/wg0.conf /bin/ip link set up dev wg0 /bin/ip route add 10.0.0.1/32 dev wg0 /usr/bin/sudo /sbin/ifconfig wg0 mtu 1300 Make executable\nchmod +x wg-setup.sh Run\n./wg-setup.sh Sources:\nhttps://github.com/WireGuard/wireguard-vyatta-ubnt/wiki/EdgeOS-and-Unifi-Gateway https://www.wireguard.com/quickstart/ https://blog.usman.network/posts/wireguard-vpn-on-a-ubiquiti-edgerouter/ ","wordCount":"1124","inLanguage":"en","datePublished":"2023-02-22T00:00:00Z","dateModified":"2023-02-22T00:00:00Z","author":{"@type":"Person","name":"Angel"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://netsparse.dev/posts/2023-02-22-setup-wireguard-edgerouter/"},"publisher":{"@type":"Organization","name":"NS","logo":{"@type":"ImageObject","url":"https://netsparse.dev/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://netsparse.dev accesskey=h title="NS (Alt + H)">NS</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://netsparse.dev/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://netsparse.dev/blog/ title=Blog><span>Blog</span></a></li><li><a href=https://netsparse.dev/projects/ title=Projects><span>Projects</span></a></li><li><a href=https://netsparse.dev/contact/ title=Contact><span>Contact</span></a></li><li><a href=https://netsparse.dev/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://netsparse.dev>Home</a>&nbsp;»&nbsp;<a href=https://netsparse.dev/posts/>Posts</a></div><h1 class=post-title>Setup WireGuard VPN Server on Edgerouter X (EdgeOS)</h1><div class=post-meta><span title='2023-02-22 00:00:00 +0000 UTC'>February 22, 2023</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;1124 words&nbsp;·&nbsp;Angel</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#breakdown aria-label=Breakdown>Breakdown</a><ul><li><a href=#step-1-installation aria-label="Step 1. Installation">Step 1. Installation</a><ul><li><a href=#verify-your-edgeos-version aria-label="Verify your EdgeOS version">Verify your EdgeOS version</a></li><li><a href=#download-wireguard aria-label="Download Wireguard">Download Wireguard</a></li><li><a href=#install-with-dpkg aria-label="Install with dpkg">Install with dpkg</a></li><li><a href=#if-there-is-no-space-available aria-label="If there is no space available">If there is no space available</a></li></ul></li><li><a href=#step-2-key-creation aria-label="Step 2. Key Creation">Step 2. Key Creation</a><ul><li><a href=#generate-server-keys aria-label="Generate Server Keys">Generate Server Keys</a></li><li><a href=#generate-client-keys aria-label="Generate Client Keys">Generate Client Keys</a></li></ul></li><li><a href=#step-3-wg0-interface-configuration aria-label="Step 3. wg0 Interface Configuration">Step 3. wg0 Interface Configuration</a></li><li><a href=#step-4-adding-peers-to-the-wg0-interface aria-label="Step 4. Adding peers to the wg0 Interface">Step 4. Adding peers to the wg0 Interface</a><ul><li><a href=#adding-client-01 aria-label="Adding Client 01">Adding Client 01</a></li><li><a href=#adding-additional-clients aria-label="Adding Additional Clients">Adding Additional Clients</a></li></ul></li><li><a href=#step-5-create-firewall-rules-for-wireguard aria-label="Step 5. Create firewall rules for WireGuard">Step 5. Create firewall rules for WireGuard</a></li><li><a href=#step-6-constructing-the-config-on-the-peer-side aria-label="Step 6. Constructing the Config on the peer side">Step 6. Constructing the Config on the peer side</a><ul><li><a href=#config-file-conf aria-label="Config File (.conf)">Config File (.conf)</a></li><li><a href=#example-client-01 aria-label="Example Client 01">Example Client 01</a></li><li><a href=#example-client-02 aria-label="Example Client 02">Example Client 02</a></li></ul></li><li><a href=#step--7-save-wireguard-keys-and-configuration-files aria-label="Step  7. Save WireGuard Keys and Configuration Files">Step 7. Save WireGuard Keys and Configuration Files</a></li></ul></li><li><a href=#quick-script aria-label="Quick Script">Quick Script</a></li></ul></div></details></div><div class=post-content><p><strong>Note: Before making any major changes, always make a backup.</strong>
Refer to the <a href=https://help.ui.com/hc/en-us/articles/360002535514-EdgeRouter-Backup-and-Restore-Configuration>official documentation</a> on how to perform one.</p><h1 id=breakdown>Breakdown<a hidden class=anchor aria-hidden=true href=#breakdown>#</a></h1><h2 id=step-1-installation>Step 1. Installation<a hidden class=anchor aria-hidden=true href=#step-1-installation>#</a></h2><p><strong>Note: The following installation guide was verified working on EdgeOS v2.0.9-hotfix.4 as of Feb 2023.</strong></p><h3 id=verify-your-edgeos-version>Verify your EdgeOS version<a hidden class=anchor aria-hidden=true href=#verify-your-edgeos-version>#</a></h3><pre tabindex=0><code>show version
</code></pre><h3 id=download-wireguard>Download Wireguard<a hidden class=anchor aria-hidden=true href=#download-wireguard>#</a></h3><p>Head over to <a href=https://github.com/WireGuard/wireguard-vyatta-ubnt/releases/>WireGuard&rsquo;s EdgeOS releases</a> and look for the <code>release</code> that matches your platform/version.</p><p><strong>On the ER-X, use <code>curl</code> to download the <code>.deb</code> file</strong></p><pre tabindex=0><code>curl -OL https://github.com/WireGuard/wireguard-vyatta-ubnt/releases/download/1.0.20220627-1/e50-v2-v1.0.20220627-v1.0.20210914.deb
</code></pre><h3 id=install-with-dpkg>Install with dpkg<a hidden class=anchor aria-hidden=true href=#install-with-dpkg>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo dpkg -i e50-v2-v1.0.20220627-v1.0.20210914.deb
</span></span></code></pre></div><p>Output Log</p><pre tabindex=0><code>user@ER-X:~$ sudo dpkg -i e50-v2-v1.0.20220627-v1.0.20210914.deb
Selecting previously unselected package wireguard.
(Reading database ... 37091 files and directories currently installed.)
Preparing to unpack e50-v2-v1.0.20220627-v1.0.20210914.deb ...
Adding &#39;diversion of /opt/vyatta/share/perl5/Vyatta/Interface.pm to /opt/vyatta/share/perl5/Vyatta/Interface.pm.vyatta by wireguard&#39;
Adding &#39;diversion of /opt/vyatta/share/vyatta-cfg/templates/firewall/options/mss-clamp/interface-type/node.def to /opt/vyatta/share/vyatta-cfg/templates/firewall/options/mss-clamp/interface-type/node.def.vyatta by wireguard&#39;
Adding &#39;diversion of /opt/vyatta/share/vyatta-cfg/templates/firewall/options/mss-clamp6/interface-type/node.def to /opt/vyatta/share/vyatta-cfg/templates/firewall/options/mss-clamp6/interface-type/node.def.vyatta by wireguard&#39;
Unpacking wireguard (1.0.20220627-1) ...
Setting up wireguard (1.0.20220627-1) ...
</code></pre><h3 id=if-there-is-no-space-available>If there is no space available<a hidden class=anchor aria-hidden=true href=#if-there-is-no-space-available>#</a></h3><p>If additional storage space is needed, you can safely delete the <strong>backup</strong> system image (not the currently running firmware).</p><pre tabindex=0><code>delete system image
</code></pre><p>You can check if wireguard is installed by running:</p><pre tabindex=0><code>wg version
</code></pre><p>Output log:</p><pre tabindex=0><code>user@ER-X:~$ wg version
wireguard-tools v1.0.20210914 - https://git.zx2c4.com/wireguard-tools/
</code></pre><h2 id=step-2-key-creation>Step 2. Key Creation<a hidden class=anchor aria-hidden=true href=#step-2-key-creation>#</a></h2><p><strong>Confirm working directory</strong></p><pre tabindex=0><code>pwd
</code></pre><h3 id=generate-server-keys>Generate Server Keys<a hidden class=anchor aria-hidden=true href=#generate-server-keys>#</a></h3><p><strong>Create folder for your server keys</strong>
You can create it in the <code>/config</code> directory to preserve your files during upgrades, and to make it easier during backups.</p><pre tabindex=0><code>cd /config
</code></pre><p><strong>Create a folder <code>wireguard</code>, then create another folder for <code>server_keys</code></strong></p><pre tabindex=0><code>mkdir wireguard; cd wireguard
mkdir server_keys; cd server_keys
</code></pre><p><strong>Generate a key pair for the Wireguard server</strong></p><pre tabindex=0><code>wg genkey | tee privatekey | wg pubkey &gt; publickey
</code></pre><p><strong>Note your public and private key for the next configuration steps.</strong></p><pre tabindex=0><code>cat publickey privatekey
</code></pre><h3 id=generate-client-keys>Generate Client Keys<a hidden class=anchor aria-hidden=true href=#generate-client-keys>#</a></h3><p><strong>Move to <code>wireguard</code> directory.</strong></p><pre tabindex=0><code>cd /config/wireguard
</code></pre><p><strong>Create folder <code>wg_clients</code></strong></p><pre tabindex=0><code>mkdir wg_clients ; cd wg_clients
</code></pre><p><strong>Create folder for <code>client01</code></strong></p><pre tabindex=0><code>mkdir client01 ; cd client01
</code></pre><p><strong>Generate client keys.</strong></p><pre tabindex=0><code>wg genkey | tee privatekey | wg pubkey &gt; publickey
</code></pre><p><strong>Note your public and private key for the next configuration steps.</strong></p><pre tabindex=0><code>cat publickey privatekey
</code></pre><p>Example output:</p><pre tabindex=0><code>user@ER-X:~$ cat privatekey publickey 
sAoqK3dXpc2UbOn2LWb/MMcHTKtU0nqHjDQiXqNcyHs=
Bf6LBfuoRDRbO4EJ+tawJXu6qu5BOWaXGK0V+uVRC3Q=
</code></pre><h2 id=step-3-wg0-interface-configuration>Step 3. wg0 Interface Configuration<a hidden class=anchor aria-hidden=true href=#step-3-wg0-interface-configuration>#</a></h2><p><strong>Enter <code>configure</code> mode</strong></p><pre tabindex=0><code>configure
</code></pre><p><strong>Set the location of the server&rsquo;s <code>private-key</code>, previously generated</strong></p><pre tabindex=0><code>set interfaces wireguard wg0 private-key &lt;server-private-key-here&gt;
</code></pre><p><strong>Create the Gateway IP for the VPN and the subnet</strong>
This subnet can be any private IP range, though make sure to check for conflicts</p><pre tabindex=0><code>set interfaces wireguard wg0 address 10.0.0.1/32
</code></pre><p><strong>Create entries in the route table for the VPN subnet</strong></p><pre tabindex=0><code>set interfaces wireguard wg0 route-allowed-ips true
</code></pre><p><strong>Set the UDP port for WG (that peers will use)</strong>
WireGuard default port is <code>51820</code>, but can be changed to any port</p><pre tabindex=0><code>set interfaces wireguard wg0 listen-port 51820
</code></pre><p>Save</p><pre tabindex=0><code>commit ; save
</code></pre><h2 id=step-4-adding-peers-to-the-wg0-interface>Step 4. Adding peers to the wg0 Interface<a hidden class=anchor aria-hidden=true href=#step-4-adding-peers-to-the-wg0-interface>#</a></h2><h3 id=adding-client-01>Adding Client 01<a hidden class=anchor aria-hidden=true href=#adding-client-01>#</a></h3><p>Note: make sure you are in <code>configure</code> mode.</p><pre tabindex=0><code>set interfaces wireguard wg0 peer &lt;public-key-here&gt;
</code></pre><pre tabindex=0><code>set interfaces wireguard wg0 peer &lt;public-key-here&gt; allowed-ips 10.0.0.5/32
</code></pre><pre tabindex=0><code>set interfaces wireguard wg0 peer &lt;public-key-here&gt; description client01
</code></pre><h3 id=adding-additional-clients>Adding Additional Clients<a hidden class=anchor aria-hidden=true href=#adding-additional-clients>#</a></h3><p>When adding additional peers, repeat the steps above, make sure to update <code>allowed-ips</code> and <code>description</code> for the new clients.</p><pre tabindex=0><code>set interfaces wireguard wg0 peer &lt;public-key-here&gt;
</code></pre><pre tabindex=0><code>set interfaces wireguard wg0 peer &lt;public-key-here&gt; allowed-ips 10.0.0.6/32
</code></pre><pre tabindex=0><code>set interfaces wireguard wg0 peer &lt;public-key-here&gt; description client02
</code></pre><p>Save</p><pre tabindex=0><code>commit ; save
</code></pre><h2 id=step-5-create-firewall-rules-for-wireguard>Step 5. Create firewall rules for WireGuard<a hidden class=anchor aria-hidden=true href=#step-5-create-firewall-rules-for-wireguard>#</a></h2><p>Create an accept rule in <code>WAN_LOCAL</code> to accept all incoming UDP connections from port <code>51820</code> (or any port of your choice).</p><pre tabindex=0><code>set firewall name WAN_LOCAL rule 50 action accept
set firewall name WAN_LOCAL rule 50 protocol udp
set firewall name WAN_LOCAL rule 50 destination port 51820
set firewall name WAN_LOCAL rule 50 description &#39;WireGuard&#39;
</code></pre><p>Save</p><pre tabindex=0><code>commit ; save
</code></pre><p>Once this is done, your <code>wg0</code> interface and firewall configuration should look something like this.</p><pre tabindex=0><code>user@ER-X$ show configuration

  wireguard wg0 {
        address 10.0.0.1/32
        listen-port 51820
        peer Bf6LBfuoRDRbO4EJ+tawJXu6qu5BOWaXGK0V+uVRC3Q= {
            allowed-ips 10.0.0.6/32
            description client02
        }
        peer Kf6LBfuoRDRbO4EJ+tawJXu6qu5BOWaXGK0V+uVRC3Q= {
            allowed-ips 10.0.0.5/32
            description client01
        }
        }
        private-key ****************
        route-allowed-ips true
    }



        }
        rule 50 {
            action accept
            description WireGuard
            destination {
                port 51820
            }
            log enable
            protocol udp
            source {
            }
        }
    }
}
</code></pre><h2 id=step-6-constructing-the-config-on-the-peer-side>Step 6. Constructing the Config on the peer side<a hidden class=anchor aria-hidden=true href=#step-6-constructing-the-config-on-the-peer-side>#</a></h2><h3 id=config-file-conf>Config File (.conf)<a hidden class=anchor aria-hidden=true href=#config-file-conf>#</a></h3><p>Create a file on the peer, with the file extension as <code>.conf</code></p><p>The peer side needs a few pieces of information to create the tunnel:</p><ul><li>The server’s public key</li><li>The server’s endpoint (public IP address, or DNS record)</li><li>The peer’s <code>private key</code></li><li>The peer’s IP address in the VPN subnet (the allowed IPs value set on the server)</li></ul><p>Therefore, the previously generated <code>client01 private-key</code> and the <code>server-public-key</code>, should be copied to the peer device.</p><p>The configuration should look something like the one below:</p><h3 id=example-client-01>Example Client 01<a hidden class=anchor aria-hidden=true href=#example-client-01>#</a></h3><pre tabindex=0><code>[Interface]
PrivateKey = &lt;private-key-here&gt;
ListenPort = 51820
Address = 10.0.0.5/32
DNS = &lt;any dns&gt;, 9.9.9.9

[Peer]
PublicKey = &lt;public-key-here&gt;
AllowedIPs = 0.0.0.0/0
Endpoint = &lt;your-public-ip-or-dynamic-dns-hostname&gt;:51820
</code></pre><h3 id=example-client-02>Example Client 02<a hidden class=anchor aria-hidden=true href=#example-client-02>#</a></h3><pre tabindex=0><code>[Interface]
PrivateKey = &lt;private-key-here&gt;
ListenPort = 51820
Address = 10.0.0.6/32
DNS = &lt;any dns&gt;, 9.9.9.9

[Peer]
PublicKey = &lt;public-key-here&gt;
AllowedIPs = 0.0.0.0/0
Endpoint = &lt;your-public-ip-or-dynamic-dns-hostname&gt;:51820
</code></pre><p>Once the <code>.conf</code> file is created, you can import that into the peer/device of your choice.</p><p>To bring up your tunnel, you can use the <code>wg-quick</code> command.</p><pre tabindex=0><code>wg-quick up client01.conf
</code></pre><p>Run <code>wg show</code> on your peer to verify you are connected to the endpoint.</p><pre tabindex=0><code>user@PC$ wg show

interface: client01
  public key: &lt;private-key&gt;
  private key: (hidden)
  listening port: 51820
  fwmark: 0xca6c

peer: &lt;peer-key&gt;
  endpoint: xx.xx.xx.xx:51820
  allowed ips: 0.0.0.0/0
  latest handshake: 11 seconds ago
  transfer: 3.11 MiB received, 6.92 MiB sent
</code></pre><h2 id=step--7-save-wireguard-keys-and-configuration-files>Step 7. Save WireGuard Keys and Configuration Files<a hidden class=anchor aria-hidden=true href=#step--7-save-wireguard-keys-and-configuration-files>#</a></h2><p>Once the above configuration is made, you can easily save the config by <a href=https://help.ui.com/hc/en-us/articles/360002535514-EdgeRouter-Backup-and-Restore-Configuration#2>running a backup</a> from the Edgerouter&rsquo;s GUI.</p><ol><li>Navigate to the <strong>System</strong> tab in the bottom-left of the GUI to download the backup configuration archive.</li></ol><p><strong>System > Configuration Management & Device Maintenance > Back Up Config</strong></p><ol start=2><li><p>Download the backup config file by clicking on the <strong>Download</strong> button.</p></li><li><p>The EdgeRouter will prompt you to save the archive on your computer.</p></li></ol><p>You can then extract this file on your local machine, and in the <code>/config</code> directory, you&rsquo;ll find the wireguard public and private keys you generated earlier.</p><h1 id=quick-script>Quick Script<a hidden class=anchor aria-hidden=true href=#quick-script>#</a></h1><p><strong>Warning, the following script is not guaranteed to work, you may need to modify it according to your specific platform/version. Use at your own risk.</strong></p><p>Determine shell with <code>echo $SHELL</code></p><pre tabindex=0><code>user@ER-X:~$ echo $SHELL
/bin/vbash
</code></pre><p>EdgeOS comes with <code>vi</code>, you can use that to create the script.</p><pre tabindex=0><code>user@ER-X:~$ touch wg-setup.sh
user@ER-X:~$ vi wg-setup.sh
</code></pre><p>NOTE: Make sure to modify your <code>$SHELL</code> in case it differs, for EdgeOS, it will usually be <code>#!/bin/vbash</code></p><p>Paste the following:</p><pre tabindex=0><code>#!/bin/vbash

/bin/ip link add dev wg0 type wireguard
/bin/ip addr add 10.0.0.1/32 dev wg0
/usr/bin/sudo /usr/bin/wg setconf wg0 /home/$USER/wg0.conf
/bin/ip link set up dev wg0
/bin/ip route add 10.0.0.1/32 dev wg0
/usr/bin/sudo /sbin/ifconfig wg0 mtu 1300
</code></pre><p>Make executable</p><pre tabindex=0><code>chmod +x wg-setup.sh
</code></pre><p>Run</p><pre tabindex=0><code>./wg-setup.sh
</code></pre><p>Sources:</p><ul><li><a href=https://github.com/WireGuard/wireguard-vyatta-ubnt/wiki/EdgeOS-and-Unifi-Gateway>https://github.com/WireGuard/wireguard-vyatta-ubnt/wiki/EdgeOS-and-Unifi-Gateway</a></li><li><a href=https://www.wireguard.com/quickstart/>https://www.wireguard.com/quickstart/</a></li><li><a href=https://blog.usman.network/posts/wireguard-vpn-on-a-ubiquiti-edgerouter/>https://blog.usman.network/posts/wireguard-vpn-on-a-ubiquiti-edgerouter/</a></li></ul></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=next href=https://netsparse.dev/posts/2023-01-30-docker-on-lxc/><span class=title>Next »</span><br><span>Running Docker containers in a Proxmox LXC container</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://netsparse.dev>NS</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>