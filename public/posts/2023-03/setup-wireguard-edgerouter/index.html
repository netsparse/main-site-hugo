<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Setup WireGuard VPN Server with Ubiquiti Edgerouter X (EdgeOS) | Netsparse · Angel Nevarez</title><meta name=keywords content><meta name=description content="WireGuard is a fast and secure VPN protocol that uses state-of-the-art cryptography. It is designed to be easy to implement and manage, and has a minimal attack surface. Its simplicity and efficiency make it well-suited for use in mobile devices and large-scale deployments.
Note: Before making any major changes on your EdgeOS router, always make a backup. Refer to the official documentation on how to perform one.
Breakdown Step 1. Installation Note: The following installation guide was verified working on EdgeOS v2."><meta name=author content="Angel"><link rel=canonical href=https://netsparse.dev/posts/2023-03/setup-wireguard-edgerouter/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://netsparse.dev/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://netsparse.dev/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://netsparse.dev/favicon.ico><link rel=mask-icon href=https://netsparse.dev/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-H4GRFCYEJN"></script>
<script>var dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-H4GRFCYEJN",{anonymize_ip:!1})}</script><meta property="og:title" content="Setup WireGuard VPN Server with Ubiquiti Edgerouter X (EdgeOS)"><meta property="og:description" content="WireGuard is a fast and secure VPN protocol that uses state-of-the-art cryptography. It is designed to be easy to implement and manage, and has a minimal attack surface. Its simplicity and efficiency make it well-suited for use in mobile devices and large-scale deployments.
Note: Before making any major changes on your EdgeOS router, always make a backup. Refer to the official documentation on how to perform one.
Breakdown Step 1. Installation Note: The following installation guide was verified working on EdgeOS v2."><meta property="og:type" content="article"><meta property="og:url" content="https://netsparse.dev/posts/2023-03/setup-wireguard-edgerouter/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-10T00:00:00+00:00"><meta property="article:modified_time" content="2023-03-10T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Setup WireGuard VPN Server with Ubiquiti Edgerouter X (EdgeOS)"><meta name=twitter:description content="WireGuard is a fast and secure VPN protocol that uses state-of-the-art cryptography. It is designed to be easy to implement and manage, and has a minimal attack surface. Its simplicity and efficiency make it well-suited for use in mobile devices and large-scale deployments.
Note: Before making any major changes on your EdgeOS router, always make a backup. Refer to the official documentation on how to perform one.
Breakdown Step 1. Installation Note: The following installation guide was verified working on EdgeOS v2."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://netsparse.dev/posts/"},{"@type":"ListItem","position":3,"name":"Setup WireGuard VPN Server with Ubiquiti Edgerouter X (EdgeOS)","item":"https://netsparse.dev/posts/2023-03/setup-wireguard-edgerouter/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Setup WireGuard VPN Server with Ubiquiti Edgerouter X (EdgeOS)","name":"Setup WireGuard VPN Server with Ubiquiti Edgerouter X (EdgeOS)","description":"WireGuard is a fast and secure VPN protocol that uses state-of-the-art cryptography. It is designed to be easy to implement and manage, and has a minimal attack surface. Its simplicity and efficiency make it well-suited for use in mobile devices and large-scale deployments.\nNote: Before making any major changes on your EdgeOS router, always make a backup. Refer to the official documentation on how to perform one.\nBreakdown Step 1. Installation Note: The following installation guide was verified working on EdgeOS v2.","keywords":[],"articleBody":"WireGuard is a fast and secure VPN protocol that uses state-of-the-art cryptography. It is designed to be easy to implement and manage, and has a minimal attack surface. Its simplicity and efficiency make it well-suited for use in mobile devices and large-scale deployments.\nNote: Before making any major changes on your EdgeOS router, always make a backup. Refer to the official documentation on how to perform one.\nBreakdown Step 1. Installation Note: The following installation guide was verified working on EdgeOS v2.0.9-hotfix.4 as of Feb 2023.\nVerify your EdgeOS version 1 show version Download Wireguard Head over to WireGuard’s EdgeOS releases and look for the release that matches your platform/version.\nOn the ER-X, use curl to download the .deb file\n1 curl -OL https://github.com/WireGuard/wireguard-vyatta-ubnt/releases/download/1.0.20220627-1/e50-v2-v1.0.20220627-v1.0.20210914.deb Install with dpkg 1 sudo dpkg -i e50-v2-v1.0.20220627-v1.0.20210914.deb Output Log\n1 2 3 4 5 6 7 8 9 user@ER-X:~$ sudo dpkg -i e50-v2-v1.0.20220627-v1.0.20210914.deb Selecting previously unselected package wireguard. (Reading database ... 37091 files and directories currently installed.) Preparing to unpack e50-v2-v1.0.20220627-v1.0.20210914.deb ... Adding 'diversion of /opt/vyatta/share/perl5/Vyatta/Interface.pm to /opt/vyatta/share/perl5/Vyatta/Interface.pm.vyatta by wireguard' Adding 'diversion of /opt/vyatta/share/vyatta-cfg/templates/firewall/options/mss-clamp/interface-type/node.def to /opt/vyatta/share/vyatta-cfg/templates/firewall/options/mss-clamp/interface-type/node.def.vyatta by wireguard' Adding 'diversion of /opt/vyatta/share/vyatta-cfg/templates/firewall/options/mss-clamp6/interface-type/node.def to /opt/vyatta/share/vyatta-cfg/templates/firewall/options/mss-clamp6/interface-type/node.def.vyatta by wireguard' Unpacking wireguard (1.0.20220627-1) ... Setting up wireguard (1.0.20220627-1) ... If there is no space available If additional storage space is needed, you can safely delete the backup system image (not the currently running firmware).\n1 delete system image You can check if wireguard is installed by running:\n1 wg version Output log:\n1 2 user@ER-X:~$ wg version wireguard-tools v1.0.20210914 - https://git.zx2c4.com/wireguard-tools/ Step 2. Key Creation Confirm working directory\n1 pwd Generate Server Keys Create folder for your server keys You can create it in the /config directory to preserve your files during upgrades, and to make it easier during backups.\n1 cd /config Create a folder wireguard, then create another folder for server_keys\n1 2 mkdir wireguard; cd wireguard mkdir server_keys; cd server_keys Generate a key pair for the Wireguard server\n1 wg genkey | tee privatekey | wg pubkey \u003e publickey Note your public and private key for the next configuration steps.\n1 cat publickey privatekey Generate Client Keys Move to wireguard directory.\n1 cd /config/wireguard Create folder wg_clients\n1 mkdir wg_clients ; cd wg_clients Create folder for client01\n1 mkdir client01 ; cd client01 Generate client keys.\n1 wg genkey | tee privatekey | wg pubkey \u003e publickey Note your public and private key for the next configuration steps.\n1 cat publickey privatekey Example output:\n1 2 3 user@ER-X:~$ cat privatekey publickey sAoqK3dXpc2UbOn2LWb/MMcHTKtU0nqHjDQiXqNcyHs= Bf6LBfuoRDRbO4EJ+tawJXu6qu5BOWaXGK0V+uVRC3Q= Step 3. wg0 Interface Configuration Enter configure mode\n1 configure Set the location of the server’s private-key, previously generated\n1 set interfaces wireguard wg0 private-key Create the Gateway IP for the VPN and the subnet This subnet can be any private IP range, though make sure to check for conflicts\n1 set interfaces wireguard wg0 address 10.0.0.1/32 Create entries in the route table for the VPN subnet\n1 set interfaces wireguard wg0 route-allowed-ips true Set the UDP port for WG (that peers will use) WireGuard default port is 51820, but can be changed to any port\n1 set interfaces wireguard wg0 listen-port 51820 Save\n1 commit ; save Step 4. Adding peers to the wg0 Interface Adding Client 01 Note: make sure you are in configure mode.\n1 set interfaces wireguard wg0 peer 1 set interfaces wireguard wg0 peer allowed-ips 10.0.0.5/32 1 set interfaces wireguard wg0 peer description client01 Adding Additional Clients When adding additional peers, repeat the steps above, make sure to update allowed-ips and description for the new clients.\n1 set interfaces wireguard wg0 peer 1 set interfaces wireguard wg0 peer allowed-ips 10.0.0.6/32 1 set interfaces wireguard wg0 peer description client02 Save\n1 commit ; save Step 5. Create firewall rules for WireGuard Create an accept rule in WAN_LOCAL to accept all incoming UDP connections from port 51820 (or any port of your choice).\n1 2 3 4 set firewall name WAN_LOCAL rule 50 action accept set firewall name WAN_LOCAL rule 50 protocol udp set firewall name WAN_LOCAL rule 50 destination port 51820 set firewall name WAN_LOCAL rule 50 description 'WireGuard' Save\n1 commit ; save Once this is done, your wg0 interface and firewall configuration should look something like this.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 user@ER-X$ show configuration wireguard wg0 { address 10.0.0.1/32 listen-port 51820 peer Bf6LBfuoRDRbO4EJ+tawJXu6qu5BOWaXGK0V+uVRC3Q= { allowed-ips 10.0.0.6/32 description client02 } peer Kf6LBfuoRDRbO4EJ+tawJXu6qu5BOWaXGK0V+uVRC3Q= { allowed-ips 10.0.0.5/32 description client01 } } private-key **************** route-allowed-ips true } } rule 50 { action accept description WireGuard destination { port 51820 } log enable protocol udp source { } } } } Step 6. Constructing the Config on the peer side Config File (.conf) Create a file on the peer, with the file extension as .conf\nThe peer side needs a few pieces of information to create the tunnel:\nThe server’s public key The server’s endpoint (public IP address, or DNS record) The peer’s private key The peer’s IP address in the VPN subnet (the allowed IPs value set on the server) Therefore, the previously generated client01 private-key and the server-public-key, should be copied to the peer device.\nThe configuration should look something like the one below:\nExample Client 01 1 2 3 4 5 6 7 8 9 10 [Interface] PrivateKey = ListenPort = 51820 Address = 10.0.0.5/32 DNS = , 9.9.9.9 [Peer] PublicKey = AllowedIPs = 0.0.0.0/0 Endpoint = :51820 Example Client 02 1 2 3 4 5 6 7 8 9 10 [Interface] PrivateKey = ListenPort = 51820 Address = 10.0.0.6/32 DNS = , 9.9.9.9 [Peer] PublicKey = AllowedIPs = 0.0.0.0/0 Endpoint = :51820 Once the .conf file is created, you can import that into the peer/device of your choice.\nTo bring up your tunnel, you can use the wg-quick command.\n1 wg-quick up client01.conf Run wg show on your peer to verify you are connected to the endpoint.\n1 2 3 4 5 6 7 8 9 10 11 12 13 user@PC$ wg show interface: client01 public key: private key: (hidden) listening port: 51820 fwmark: 0xca6c peer: endpoint: xx.xx.xx.xx:51820 allowed ips: 0.0.0.0/0 latest handshake: 11 seconds ago transfer: 3.11 MiB received, 6.92 MiB sent Step 7. Save WireGuard Keys and Configuration Files Once the above configuration is made, you can easily save the config by running a backup from the Edgerouter’s GUI.\nNavigate to the System tab in the bottom-left of the GUI to download the backup configuration archive. System \u003e Configuration Management \u0026 Device Maintenance \u003e Back Up Config\nDownload the backup config file by clicking on the Download button.\nThe EdgeRouter will prompt you to save the archive on your computer.\nYou can then extract this file on your local machine, and in the /config directory, you’ll find the wireguard public and private keys you generated earlier.\nQuick Script Warning, the following script is not guaranteed to work, you may need to modify it according to your specific platform/version. Use at your own risk.\nDetermine shell with echo $SHELL\n1 2 user@ER-X:~$ echo $SHELL /bin/vbash EdgeOS comes with vi, you can use that to create the script.\n1 2 user@ER-X:~$ touch wg-setup.sh user@ER-X:~$ vi wg-setup.sh NOTE: Make sure to modify your $SHELL in case it differs, for EdgeOS, it will usually be #!/bin/vbash\nPaste the following:\n1 2 3 4 5 6 7 8 #!/bin/vbash /bin/ip link add dev wg0 type wireguard /bin/ip addr add 10.0.0.1/32 dev wg0 /usr/bin/sudo /usr/bin/wg setconf wg0 /home/$USER/wg0.conf /bin/ip link set up dev wg0 /bin/ip route add 10.0.0.1/32 dev wg0 /usr/bin/sudo /sbin/ifconfig wg0 mtu 1300 Make executable\n1 chmod +x wg-setup.sh Run\n1 ./wg-setup.sh Sources:\nhttps://github.com/WireGuard/wireguard-vyatta-ubnt/wiki/EdgeOS-and-Unifi-Gateway https://www.wireguard.com/quickstart/ https://blog.usman.network/posts/wireguard-vpn-on-a-ubiquiti-edgerouter/ ","wordCount":"1301","inLanguage":"en","datePublished":"2023-03-10T00:00:00Z","dateModified":"2023-03-10T00:00:00Z","author":{"@type":"Person","name":"Angel"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://netsparse.dev/posts/2023-03/setup-wireguard-edgerouter/"},"publisher":{"@type":"Organization","name":"Netsparse · Angel Nevarez","logo":{"@type":"ImageObject","url":"https://netsparse.dev/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://netsparse.dev accesskey=h title=Home><img src=/images/site-logo/cable-128.ico alt=logo aria-label=logo width=30 height=30></a></a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Dark/Light Mode)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://netsparse.dev/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://netsparse.dev/blog/ title=Blog><span>Blog</span></a></li><li><a href=https://netsparse.dev/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://netsparse.dev/projects/ title=Projects><span>Projects</span></a></li><li><a href=https://netsparse.dev/contact/ title=Contact><span>Contact</span></a></li><li><a href=https://netsparse.dev/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://netsparse.dev>Home</a>&nbsp;»&nbsp;<a href=https://netsparse.dev/posts/>Posts</a></div><h1 class=post-title>Setup WireGuard VPN Server with Ubiquiti Edgerouter X (EdgeOS)</h1><div class=post-meta><span title='2023-03-10 00:00:00 +0000 UTC'>March 10, 2023</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;1301 words&nbsp;·&nbsp;Angel</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#breakdown aria-label=Breakdown>Breakdown</a><ul><li><a href=#step-1-installation aria-label="Step 1. Installation">Step 1. Installation</a><ul><li><a href=#verify-your-edgeos-version aria-label="Verify your EdgeOS version">Verify your EdgeOS version</a></li><li><a href=#download-wireguard aria-label="Download Wireguard">Download Wireguard</a></li><li><a href=#install-with-dpkg aria-label="Install with dpkg">Install with dpkg</a></li><li><a href=#if-there-is-no-space-available aria-label="If there is no space available">If there is no space available</a></li></ul></li><li><a href=#step-2-key-creation aria-label="Step 2. Key Creation">Step 2. Key Creation</a><ul><li><a href=#generate-server-keys aria-label="Generate Server Keys">Generate Server Keys</a></li><li><a href=#generate-client-keys aria-label="Generate Client Keys">Generate Client Keys</a></li></ul></li><li><a href=#step-3-wg0-interface-configuration aria-label="Step 3. wg0 Interface Configuration">Step 3. wg0 Interface Configuration</a></li><li><a href=#step-4-adding-peers-to-the-wg0-interface aria-label="Step 4. Adding peers to the wg0 Interface">Step 4. Adding peers to the wg0 Interface</a><ul><li><a href=#adding-client-01 aria-label="Adding Client 01">Adding Client 01</a></li><li><a href=#adding-additional-clients aria-label="Adding Additional Clients">Adding Additional Clients</a></li></ul></li><li><a href=#step-5-create-firewall-rules-for-wireguard aria-label="Step 5. Create firewall rules for WireGuard">Step 5. Create firewall rules for WireGuard</a></li><li><a href=#step-6-constructing-the-config-on-the-peer-side aria-label="Step 6. Constructing the Config on the peer side">Step 6. Constructing the Config on the peer side</a><ul><li><a href=#config-file-conf aria-label="Config File (.conf)">Config File (.conf)</a></li><li><a href=#example-client-01 aria-label="Example Client 01">Example Client 01</a></li><li><a href=#example-client-02 aria-label="Example Client 02">Example Client 02</a></li></ul></li><li><a href=#step--7-save-wireguard-keys-and-configuration-files aria-label="Step  7. Save WireGuard Keys and Configuration Files">Step 7. Save WireGuard Keys and Configuration Files</a></li></ul></li><li><a href=#quick-script aria-label="Quick Script">Quick Script</a></li></ul></div></details></div><div class=post-content><p><a href=https://www.wireguard.com/>WireGuard</a> is a fast and secure VPN protocol that uses state-of-the-art cryptography. It is designed to be easy to implement and manage, and has a minimal attack surface. Its simplicity and efficiency make it well-suited for use in mobile devices and large-scale deployments.</p><p><strong>Note: Before making any major changes on your EdgeOS router, always make a backup.</strong>
Refer to the <a href=https://help.ui.com/hc/en-us/articles/360002535514-EdgeRouter-Backup-and-Restore-Configuration>official documentation</a> on how to perform one.</p><h1 id=breakdown>Breakdown<a hidden class=anchor aria-hidden=true href=#breakdown>#</a></h1><h2 id=step-1-installation>Step 1. Installation<a hidden class=anchor aria-hidden=true href=#step-1-installation>#</a></h2><p><strong>Note: The following installation guide was verified working on EdgeOS v2.0.9-hotfix.4 as of Feb 2023.</strong></p><h3 id=verify-your-edgeos-version>Verify your EdgeOS version<a hidden class=anchor aria-hidden=true href=#verify-your-edgeos-version>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>show version
</span></span></code></pre></td></tr></table></div></div><h3 id=download-wireguard>Download Wireguard<a hidden class=anchor aria-hidden=true href=#download-wireguard>#</a></h3><p>Head over to <a href=https://github.com/WireGuard/wireguard-vyatta-ubnt/releases/>WireGuard&rsquo;s EdgeOS releases</a> and look for the <code>release</code> that matches your platform/version.</p><p><strong>On the ER-X, use <code>curl</code> to download the <code>.deb</code> file</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -OL https://github.com/WireGuard/wireguard-vyatta-ubnt/releases/download/1.0.20220627-1/e50-v2-v1.0.20220627-v1.0.20210914.deb
</span></span></code></pre></td></tr></table></div></div><h3 id=install-with-dpkg>Install with dpkg<a hidden class=anchor aria-hidden=true href=#install-with-dpkg>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo dpkg -i e50-v2-v1.0.20220627-v1.0.20210914.deb
</span></span></code></pre></td></tr></table></div></div><p>Output Log</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>user@ER-X:~$ sudo dpkg -i e50-v2-v1.0.20220627-v1.0.20210914.deb
</span></span><span class=line><span class=cl>Selecting previously unselected package wireguard.
</span></span><span class=line><span class=cl><span class=o>(</span>Reading database ... <span class=m>37091</span> files and directories currently installed.<span class=o>)</span>
</span></span><span class=line><span class=cl>Preparing to unpack e50-v2-v1.0.20220627-v1.0.20210914.deb ...
</span></span><span class=line><span class=cl>Adding <span class=s1>&#39;diversion of /opt/vyatta/share/perl5/Vyatta/Interface.pm to /opt/vyatta/share/perl5/Vyatta/Interface.pm.vyatta by wireguard&#39;</span>
</span></span><span class=line><span class=cl>Adding <span class=s1>&#39;diversion of /opt/vyatta/share/vyatta-cfg/templates/firewall/options/mss-clamp/interface-type/node.def to /opt/vyatta/share/vyatta-cfg/templates/firewall/options/mss-clamp/interface-type/node.def.vyatta by wireguard&#39;</span>
</span></span><span class=line><span class=cl>Adding <span class=s1>&#39;diversion of /opt/vyatta/share/vyatta-cfg/templates/firewall/options/mss-clamp6/interface-type/node.def to /opt/vyatta/share/vyatta-cfg/templates/firewall/options/mss-clamp6/interface-type/node.def.vyatta by wireguard&#39;</span>
</span></span><span class=line><span class=cl>Unpacking wireguard <span class=o>(</span>1.0.20220627-1<span class=o>)</span> ...
</span></span><span class=line><span class=cl>Setting up wireguard <span class=o>(</span>1.0.20220627-1<span class=o>)</span> ...
</span></span></code></pre></td></tr></table></div></div><h3 id=if-there-is-no-space-available>If there is no space available<a hidden class=anchor aria-hidden=true href=#if-there-is-no-space-available>#</a></h3><p>If additional storage space is needed, you can safely delete the <strong>backup</strong> system image (not the currently running firmware).</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>delete system image
</span></span></code></pre></td></tr></table></div></div><p>You can check if wireguard is installed by running:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>wg version
</span></span></code></pre></td></tr></table></div></div><p>Output log:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>user@ER-X:~$ wg version
</span></span><span class=line><span class=cl>wireguard-tools v1.0.20210914 - https://git.zx2c4.com/wireguard-tools/
</span></span></code></pre></td></tr></table></div></div><h2 id=step-2-key-creation>Step 2. Key Creation<a hidden class=anchor aria-hidden=true href=#step-2-key-creation>#</a></h2><p><strong>Confirm working directory</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>pwd
</span></span></code></pre></td></tr></table></div></div><h3 id=generate-server-keys>Generate Server Keys<a hidden class=anchor aria-hidden=true href=#generate-server-keys>#</a></h3><p><strong>Create folder for your server keys</strong>
You can create it in the <code>/config</code> directory to preserve your files during upgrades, and to make it easier during backups.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>cd /config
</span></span></code></pre></td></tr></table></div></div><p><strong>Create a folder <code>wireguard</code>, then create another folder for <code>server_keys</code></strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>mkdir wireguard; cd wireguard
</span></span><span class=line><span class=cl>mkdir server_keys; cd server_keys
</span></span></code></pre></td></tr></table></div></div><p><strong>Generate a key pair for the Wireguard server</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>wg genkey | tee privatekey | wg pubkey &gt; publickey
</span></span></code></pre></td></tr></table></div></div><p><strong>Note your public and private key for the next configuration steps.</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>cat publickey privatekey
</span></span></code></pre></td></tr></table></div></div><h3 id=generate-client-keys>Generate Client Keys<a hidden class=anchor aria-hidden=true href=#generate-client-keys>#</a></h3><p><strong>Move to <code>wireguard</code> directory.</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>cd /config/wireguard
</span></span></code></pre></td></tr></table></div></div><p><strong>Create folder <code>wg_clients</code></strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>mkdir wg_clients ; cd wg_clients
</span></span></code></pre></td></tr></table></div></div><p><strong>Create folder for <code>client01</code></strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>mkdir client01 ; cd client01
</span></span></code></pre></td></tr></table></div></div><p><strong>Generate client keys.</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>wg genkey | tee privatekey | wg pubkey &gt; publickey
</span></span></code></pre></td></tr></table></div></div><p><strong>Note your public and private key for the next configuration steps.</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>cat publickey privatekey
</span></span></code></pre></td></tr></table></div></div><p>Example output:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>user@ER-X:~$ cat privatekey publickey 
</span></span><span class=line><span class=cl>sAoqK3dXpc2UbOn2LWb/MMcHTKtU0nqHjDQiXqNcyHs=
</span></span><span class=line><span class=cl>Bf6LBfuoRDRbO4EJ+tawJXu6qu5BOWaXGK0V+uVRC3Q=
</span></span></code></pre></td></tr></table></div></div><h2 id=step-3-wg0-interface-configuration>Step 3. wg0 Interface Configuration<a hidden class=anchor aria-hidden=true href=#step-3-wg0-interface-configuration>#</a></h2><p><strong>Enter <code>configure</code> mode</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>configure
</span></span></code></pre></td></tr></table></div></div><p><strong>Set the location of the server&rsquo;s <code>private-key</code>, previously generated</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>set interfaces wireguard wg0 private-key &lt;server-private-key-here&gt;
</span></span></code></pre></td></tr></table></div></div><p><strong>Create the Gateway IP for the VPN and the subnet</strong>
This subnet can be any private IP range, though make sure to check for conflicts</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>set interfaces wireguard wg0 address 10.0.0.1/32
</span></span></code></pre></td></tr></table></div></div><p><strong>Create entries in the route table for the VPN subnet</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>set interfaces wireguard wg0 route-allowed-ips true
</span></span></code></pre></td></tr></table></div></div><p><strong>Set the UDP port for WG (that peers will use)</strong>
WireGuard default port is <code>51820</code>, but can be changed to any port</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>set interfaces wireguard wg0 listen-port 51820
</span></span></code></pre></td></tr></table></div></div><p>Save</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>commit ; save
</span></span></code></pre></td></tr></table></div></div><h2 id=step-4-adding-peers-to-the-wg0-interface>Step 4. Adding peers to the wg0 Interface<a hidden class=anchor aria-hidden=true href=#step-4-adding-peers-to-the-wg0-interface>#</a></h2><h3 id=adding-client-01>Adding Client 01<a hidden class=anchor aria-hidden=true href=#adding-client-01>#</a></h3><p>Note: make sure you are in <code>configure</code> mode.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>set interfaces wireguard wg0 peer &lt;public-key-here&gt;
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>set interfaces wireguard wg0 peer &lt;public-key-here&gt; allowed-ips 10.0.0.5/32
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>set interfaces wireguard wg0 peer &lt;public-key-here&gt; description client01
</span></span></code></pre></td></tr></table></div></div><h3 id=adding-additional-clients>Adding Additional Clients<a hidden class=anchor aria-hidden=true href=#adding-additional-clients>#</a></h3><p>When adding additional peers, repeat the steps above, make sure to update <code>allowed-ips</code> and <code>description</code> for the new clients.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>set interfaces wireguard wg0 peer &lt;public-key-here&gt;
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>set interfaces wireguard wg0 peer &lt;public-key-here&gt; allowed-ips 10.0.0.6/32
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>set interfaces wireguard wg0 peer &lt;public-key-here&gt; description client02
</span></span></code></pre></td></tr></table></div></div><p>Save</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>commit ; save
</span></span></code></pre></td></tr></table></div></div><h2 id=step-5-create-firewall-rules-for-wireguard>Step 5. Create firewall rules for WireGuard<a hidden class=anchor aria-hidden=true href=#step-5-create-firewall-rules-for-wireguard>#</a></h2><p>Create an accept rule in <code>WAN_LOCAL</code> to accept all incoming UDP connections from port <code>51820</code> (or any port of your choice).</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>set firewall name WAN_LOCAL rule 50 action accept
</span></span><span class=line><span class=cl>set firewall name WAN_LOCAL rule 50 protocol udp
</span></span><span class=line><span class=cl>set firewall name WAN_LOCAL rule 50 destination port 51820
</span></span><span class=line><span class=cl>set firewall name WAN_LOCAL rule 50 description &#39;WireGuard&#39;
</span></span></code></pre></td></tr></table></div></div><p>Save</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>commit ; save
</span></span></code></pre></td></tr></table></div></div><p>Once this is done, your <code>wg0</code> interface and firewall configuration should look something like this.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>user@ER-X$ show configuration
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  wireguard wg0 <span class=o>{</span>
</span></span><span class=line><span class=cl>        address 10.0.0.1/32
</span></span><span class=line><span class=cl>        listen-port <span class=m>51820</span>
</span></span><span class=line><span class=cl>        peer Bf6LBfuoRDRbO4EJ+tawJXu6qu5BOWaXGK0V+uVRC3Q<span class=o>=</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            allowed-ips 10.0.0.6/32
</span></span><span class=line><span class=cl>            description client02
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        peer Kf6LBfuoRDRbO4EJ+tawJXu6qu5BOWaXGK0V+uVRC3Q<span class=o>=</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            allowed-ips 10.0.0.5/32
</span></span><span class=line><span class=cl>            description client01
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        private-key ****************
</span></span><span class=line><span class=cl>        route-allowed-ips <span class=nb>true</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        rule <span class=m>50</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            action accept
</span></span><span class=line><span class=cl>            description WireGuard
</span></span><span class=line><span class=cl>            destination <span class=o>{</span>
</span></span><span class=line><span class=cl>                port <span class=m>51820</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            log <span class=nb>enable</span>
</span></span><span class=line><span class=cl>            protocol udp
</span></span><span class=line><span class=cl>            <span class=nb>source</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=step-6-constructing-the-config-on-the-peer-side>Step 6. Constructing the Config on the peer side<a hidden class=anchor aria-hidden=true href=#step-6-constructing-the-config-on-the-peer-side>#</a></h2><h3 id=config-file-conf>Config File (.conf)<a hidden class=anchor aria-hidden=true href=#config-file-conf>#</a></h3><p>Create a file on the peer, with the file extension as <code>.conf</code></p><p>The peer side needs a few pieces of information to create the tunnel:</p><ul><li>The server’s public key</li><li>The server’s endpoint (public IP address, or DNS record)</li><li>The peer’s <code>private key</code></li><li>The peer’s IP address in the VPN subnet (the allowed IPs value set on the server)</li></ul><p>Therefore, the previously generated <code>client01 private-key</code> and the <code>server-public-key</code>, should be copied to the peer device.</p><p>The configuration should look something like the one below:</p><h3 id=example-client-01>Example Client 01<a hidden class=anchor aria-hidden=true href=#example-client-01>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[Interface]
</span></span><span class=line><span class=cl>PrivateKey = &lt;private-key-here&gt;
</span></span><span class=line><span class=cl>ListenPort = 51820
</span></span><span class=line><span class=cl>Address = 10.0.0.5/32
</span></span><span class=line><span class=cl>DNS = &lt;any dns&gt;, 9.9.9.9
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[Peer]
</span></span><span class=line><span class=cl>PublicKey = &lt;public-key-here&gt;
</span></span><span class=line><span class=cl>AllowedIPs = 0.0.0.0/0
</span></span><span class=line><span class=cl>Endpoint = &lt;your-public-ip-or-dynamic-dns-hostname&gt;:51820
</span></span></code></pre></td></tr></table></div></div><h3 id=example-client-02>Example Client 02<a hidden class=anchor aria-hidden=true href=#example-client-02>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[Interface]
</span></span><span class=line><span class=cl>PrivateKey = &lt;private-key-here&gt;
</span></span><span class=line><span class=cl>ListenPort = 51820
</span></span><span class=line><span class=cl>Address = 10.0.0.6/32
</span></span><span class=line><span class=cl>DNS = &lt;any dns&gt;, 9.9.9.9
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[Peer]
</span></span><span class=line><span class=cl>PublicKey = &lt;public-key-here&gt;
</span></span><span class=line><span class=cl>AllowedIPs = 0.0.0.0/0
</span></span><span class=line><span class=cl>Endpoint = &lt;your-public-ip-or-dynamic-dns-hostname&gt;:51820
</span></span></code></pre></td></tr></table></div></div><p>Once the <code>.conf</code> file is created, you can import that into the peer/device of your choice.</p><p>To bring up your tunnel, you can use the <code>wg-quick</code> command.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>wg-quick up client01.conf
</span></span></code></pre></td></tr></table></div></div><p>Run <code>wg show</code> on your peer to verify you are connected to the endpoint.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>user@PC$ wg show
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>interface: client01
</span></span><span class=line><span class=cl>  public key: &lt;private-key&gt;
</span></span><span class=line><span class=cl>  private key: <span class=o>(</span>hidden<span class=o>)</span>
</span></span><span class=line><span class=cl>  listening port: <span class=m>51820</span>
</span></span><span class=line><span class=cl>  fwmark: 0xca6c
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>peer: &lt;peer-key&gt;
</span></span><span class=line><span class=cl>  endpoint: xx.xx.xx.xx:51820
</span></span><span class=line><span class=cl>  allowed ips: 0.0.0.0/0
</span></span><span class=line><span class=cl>  latest handshake: <span class=m>11</span> seconds ago
</span></span><span class=line><span class=cl>  transfer: 3.11 MiB received, 6.92 MiB sent
</span></span></code></pre></td></tr></table></div></div><h2 id=step--7-save-wireguard-keys-and-configuration-files>Step 7. Save WireGuard Keys and Configuration Files<a hidden class=anchor aria-hidden=true href=#step--7-save-wireguard-keys-and-configuration-files>#</a></h2><p>Once the above configuration is made, you can easily save the config by <a href=https://help.ui.com/hc/en-us/articles/360002535514-EdgeRouter-Backup-and-Restore-Configuration#2>running a backup</a> from the Edgerouter&rsquo;s GUI.</p><ol><li>Navigate to the <strong>System</strong> tab in the bottom-left of the GUI to download the backup configuration archive.</li></ol><p><strong>System > Configuration Management & Device Maintenance > Back Up Config</strong></p><ol start=2><li><p>Download the backup config file by clicking on the <strong>Download</strong> button.</p></li><li><p>The EdgeRouter will prompt you to save the archive on your computer.</p></li></ol><p>You can then extract this file on your local machine, and in the <code>/config</code> directory, you&rsquo;ll find the wireguard public and private keys you generated earlier.</p><h1 id=quick-script>Quick Script<a hidden class=anchor aria-hidden=true href=#quick-script>#</a></h1><p><strong>Warning, the following script is not guaranteed to work, you may need to modify it according to your specific platform/version. Use at your own risk.</strong></p><p>Determine shell with <code>echo $SHELL</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>user@ER-X:~$ echo $SHELL
</span></span><span class=line><span class=cl>/bin/vbash
</span></span></code></pre></td></tr></table></div></div><p>EdgeOS comes with <code>vi</code>, you can use that to create the script.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>user@ER-X:~$ touch wg-setup.sh
</span></span><span class=line><span class=cl>user@ER-X:~$ vi wg-setup.sh
</span></span></code></pre></td></tr></table></div></div><p>NOTE: Make sure to modify your <code>$SHELL</code> in case it differs, for EdgeOS, it will usually be <code>#!/bin/vbash</code></p><p>Paste the following:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/vbash
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>/bin/ip link add dev wg0 <span class=nb>type</span> wireguard
</span></span><span class=line><span class=cl>/bin/ip addr add 10.0.0.1/32 dev wg0
</span></span><span class=line><span class=cl>/usr/bin/sudo /usr/bin/wg setconf wg0 /home/<span class=nv>$USER</span>/wg0.conf
</span></span><span class=line><span class=cl>/bin/ip link <span class=nb>set</span> up dev wg0
</span></span><span class=line><span class=cl>/bin/ip route add 10.0.0.1/32 dev wg0
</span></span><span class=line><span class=cl>/usr/bin/sudo /sbin/ifconfig wg0 mtu <span class=m>1300</span>
</span></span></code></pre></td></tr></table></div></div><p>Make executable</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>chmod +x wg-setup.sh
</span></span></code></pre></td></tr></table></div></div><p>Run</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>./wg-setup.sh
</span></span></code></pre></td></tr></table></div></div><p>Sources:</p><ul><li><a href=https://github.com/WireGuard/wireguard-vyatta-ubnt/wiki/EdgeOS-and-Unifi-Gateway>https://github.com/WireGuard/wireguard-vyatta-ubnt/wiki/EdgeOS-and-Unifi-Gateway</a></li><li><a href=https://www.wireguard.com/quickstart/>https://www.wireguard.com/quickstart/</a></li><li><a href=https://blog.usman.network/posts/wireguard-vpn-on-a-ubiquiti-edgerouter/>https://blog.usman.network/posts/wireguard-vpn-on-a-ubiquiti-edgerouter/</a></li></ul></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://netsparse.dev/posts/2023-03/hands-on-python/><span class=title>« Prev</span><br><span>Hands-on with Python</span></a>
<a class=next href=https://netsparse.dev/posts/2023-03/take-your-ad-blocking-with-you-with-nextdns/><span class=title>Next »</span><br><span>Take Your Ad Blocking With You On The Go With NextDNS</span></a></nav></footer><script src=https://utteranc.es/client.js repo=netsparse/main-site-hugo issue-term=pathname theme=photon-dark crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2023 <a href=https://netsparse.dev>Netsparse · Angel Nevarez</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>